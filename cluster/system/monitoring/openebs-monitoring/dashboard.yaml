---
apiVersion: v1
kind: ConfigMap
metadata:
  name: openebs-dashboard
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  openebs-pvc-overview.json: |
    {
      "annotations": { "list": [] },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 1,
      "links": [],
      "panels": [
        {
          "title": "PVC Usage Overview",
          "type": "row",
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 },
          "collapsed": false
        },
        {
          "title": "Total PVCs",
          "type": "stat",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 4, "w": 4, "x": 0, "y": 1 },
          "fieldConfig": {
            "defaults": {
              "thresholds": {
                "steps": [
                  { "color": "green", "value": null }
                ]
              }
            },
            "overrides": []
          },
          "options": {
            "reduceOptions": { "calcs": ["lastNotNull"] },
            "colorMode": "value",
            "graphMode": "none",
            "textMode": "auto"
          },
          "targets": [
            {
              "expr": "count(kube_persistentvolumeclaim_info{storageclass=\"openebs-lvmpv\"})",
              "legendFormat": "PVCs"
            }
          ]
        },
        {
          "title": "Bound PVCs",
          "type": "stat",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 4, "w": 4, "x": 4, "y": 1 },
          "fieldConfig": {
            "defaults": {
              "thresholds": {
                "steps": [
                  { "color": "green", "value": null }
                ]
              }
            },
            "overrides": []
          },
          "options": {
            "reduceOptions": { "calcs": ["lastNotNull"] },
            "colorMode": "value",
            "graphMode": "none"
          },
          "targets": [
            {
              "expr": "count(kube_persistentvolumeclaim_status_phase{phase=\"Bound\", storageclass=\"openebs-lvmpv\"})",
              "legendFormat": "Bound"
            }
          ]
        },
        {
          "title": "Pending PVCs",
          "type": "stat",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 4, "w": 4, "x": 8, "y": 1 },
          "fieldConfig": {
            "defaults": {
              "thresholds": {
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 1 },
                  { "color": "red", "value": 3 }
                ]
              }
            },
            "overrides": []
          },
          "options": {
            "reduceOptions": { "calcs": ["lastNotNull"] },
            "colorMode": "value",
            "graphMode": "none"
          },
          "targets": [
            {
              "expr": "count(kube_persistentvolumeclaim_status_phase{phase=\"Pending\", storageclass=\"openebs-lvmpv\"}) or vector(0)",
              "legendFormat": "Pending"
            }
          ]
        },
        {
          "title": "Lost PVCs",
          "type": "stat",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 4, "w": 4, "x": 12, "y": 1 },
          "fieldConfig": {
            "defaults": {
              "thresholds": {
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "red", "value": 1 }
                ]
              }
            },
            "overrides": []
          },
          "options": {
            "reduceOptions": { "calcs": ["lastNotNull"] },
            "colorMode": "value",
            "graphMode": "none"
          },
          "targets": [
            {
              "expr": "count(kube_persistentvolumeclaim_status_phase{phase=\"Lost\", storageclass=\"openebs-lvmpv\"}) or vector(0)",
              "legendFormat": "Lost"
            }
          ]
        },
        {
          "title": "Active Alerts",
          "type": "stat",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 4, "w": 8, "x": 16, "y": 1 },
          "fieldConfig": {
            "defaults": {
              "thresholds": {
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "orange", "value": 1 },
                  { "color": "red", "value": 3 }
                ]
              }
            },
            "overrides": []
          },
          "options": {
            "reduceOptions": { "calcs": ["lastNotNull"] },
            "colorMode": "value",
            "graphMode": "none"
          },
          "targets": [
            {
              "expr": "count(ALERTS{alertstate=\"firing\", alertname=~\"PVC.*\"}) or vector(0)",
              "legendFormat": "Firing"
            }
          ]
        },
        {
          "title": "PVC Capacity Usage",
          "type": "row",
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 5 },
          "collapsed": false
        },
        {
          "title": "PVC Usage %",
          "type": "table",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 8, "w": 24, "x": 0, "y": 6 },
          "fieldConfig": {
            "defaults": {
              "custom": {
                "align": "auto",
                "cellOptions": { "type": "auto" }
              },
              "thresholds": {
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 70 },
                  { "color": "orange", "value": 85 },
                  { "color": "red", "value": 95 }
                ]
              }
            },
            "overrides": [
              {
                "matcher": { "id": "byName", "options": "Usage %" },
                "properties": [
                  { "id": "custom.cellOptions", "value": { "mode": "gradient", "type": "gauge" } },
                  { "id": "max", "value": 100 },
                  { "id": "min", "value": 0 },
                  { "id": "unit", "value": "percent" }
                ]
              },
              {
                "matcher": { "id": "byName", "options": "Capacity" },
                "properties": [
                  { "id": "unit", "value": "bytes" }
                ]
              },
              {
                "matcher": { "id": "byName", "options": "Used" },
                "properties": [
                  { "id": "unit", "value": "bytes" }
                ]
              },
              {
                "matcher": { "id": "byName", "options": "Available" },
                "properties": [
                  { "id": "unit", "value": "bytes" }
                ]
              }
            ]
          },
          "options": {
            "showHeader": true,
            "sortBy": [
              { "displayName": "Usage %", "desc": true }
            ]
          },
          "transformations": [
            {
              "id": "joinByField",
              "options": { "byField": "persistentvolumeclaim", "mode": "outer" }
            },
            {
              "id": "organize",
              "options": {
                "excludeByName": {
                  "Time": true,
                  "Time 1": true,
                  "Time 2": true,
                  "Time 3": true,
                  "Time 4": true,
                  "__name__": true,
                  "__name__ 1": true,
                  "__name__ 2": true,
                  "__name__ 3": true,
                  "endpoint": true,
                  "instance": true,
                  "job": true,
                  "metrics_path": true,
                  "node": true,
                  "service": true
                },
                "renameByName": {
                  "namespace": "Namespace",
                  "persistentvolumeclaim": "PVC",
                  "Value #A": "Usage %",
                  "Value #B": "Capacity",
                  "Value #C": "Used",
                  "Value #D": "Available"
                }
              }
            }
          ],
          "targets": [
            {
              "expr": "round((1 - kubelet_volume_stats_available_bytes{namespace=~\"$namespace\"} / kubelet_volume_stats_capacity_bytes{namespace=~\"$namespace\"}) * 100, 0.1)",
              "legendFormat": "",
              "format": "table",
              "instant": true,
              "refId": "A"
            },
            {
              "expr": "kubelet_volume_stats_capacity_bytes{namespace=~\"$namespace\"}",
              "legendFormat": "",
              "format": "table",
              "instant": true,
              "refId": "B"
            },
            {
              "expr": "kubelet_volume_stats_used_bytes{namespace=~\"$namespace\"}",
              "legendFormat": "",
              "format": "table",
              "instant": true,
              "refId": "C"
            },
            {
              "expr": "kubelet_volume_stats_available_bytes{namespace=~\"$namespace\"}",
              "legendFormat": "",
              "format": "table",
              "instant": true,
              "refId": "D"
            }
          ]
        },
        {
          "title": "PVC Usage Over Time",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 8, "w": 24, "x": 0, "y": 14 },
          "fieldConfig": {
            "defaults": {
              "unit": "percentunit",
              "min": 0,
              "max": 1,
              "custom": {
                "lineWidth": 1,
                "fillOpacity": 10,
                "drawStyle": "line",
                "pointSize": 5,
                "showPoints": "never"
              },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 0.7 },
                  { "color": "orange", "value": 0.85 },
                  { "color": "red", "value": 0.95 }
                ]
              }
            },
            "overrides": []
          },
          "options": {
            "tooltip": { "mode": "multi", "sort": "desc" },
            "legend": { "displayMode": "table", "placement": "right", "calcs": ["lastNotNull", "max"] }
          },
          "targets": [
            {
              "expr": "1 - (kubelet_volume_stats_available_bytes{namespace=~\"$namespace\"} / kubelet_volume_stats_capacity_bytes{namespace=~\"$namespace\"})",
              "legendFormat": "{{ namespace }}/{{ persistentvolumeclaim }}"
            }
          ]
        },
        {
          "title": "Inodes Usage Over Time",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 8, "w": 24, "x": 0, "y": 22 },
          "fieldConfig": {
            "defaults": {
              "unit": "percentunit",
              "min": 0,
              "max": 1,
              "custom": {
                "lineWidth": 1,
                "fillOpacity": 10,
                "drawStyle": "line",
                "pointSize": 5,
                "showPoints": "never"
              },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 0.7 },
                  { "color": "red", "value": 0.95 }
                ]
              }
            },
            "overrides": []
          },
          "options": {
            "tooltip": { "mode": "multi", "sort": "desc" },
            "legend": { "displayMode": "table", "placement": "right", "calcs": ["lastNotNull", "max"] }
          },
          "targets": [
            {
              "expr": "1 - (kubelet_volume_stats_inodes_free{namespace=~\"$namespace\"} / kubelet_volume_stats_inodes{namespace=~\"$namespace\"})",
              "legendFormat": "{{ namespace }}/{{ persistentvolumeclaim }}"
            }
          ]
        },
        {
          "title": "CSI Operations",
          "type": "row",
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 30 },
          "collapsed": false
        },
        {
          "title": "CSI gRPC Calls Rate",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 31 },
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "custom": {
                "lineWidth": 1,
                "fillOpacity": 10,
                "drawStyle": "line",
                "showPoints": "never"
              }
            },
            "overrides": []
          },
          "options": {
            "tooltip": { "mode": "multi" },
            "legend": { "displayMode": "list", "placement": "bottom" }
          },
          "targets": [
            {
              "expr": "rate(csi_operations_seconds_count{driver_name=\"local.csi.openebs.io\"}[5m])",
              "legendFormat": "{{ grpc_method }}"
            }
          ]
        },
        {
          "title": "CSI gRPC Errors Rate",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 31 },
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "custom": {
                "lineWidth": 1,
                "fillOpacity": 10,
                "drawStyle": "line",
                "showPoints": "never"
              },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "red", "value": 0.01 }
                ]
              }
            },
            "overrides": []
          },
          "options": {
            "tooltip": { "mode": "multi" },
            "legend": { "displayMode": "list", "placement": "bottom" }
          },
          "targets": [
            {
              "expr": "rate(csi_operations_seconds_count{driver_name=\"local.csi.openebs.io\", grpc_status_code!=\"OK\"}[5m])",
              "legendFormat": "{{ grpc_method }} ({{ grpc_status_code }})"
            }
          ]
        },
        {
          "title": "OpenEBS Pods",
          "type": "row",
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 39 },
          "collapsed": false
        },
        {
          "title": "OpenEBS Pod Status",
          "type": "table",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 6, "w": 24, "x": 0, "y": 40 },
          "fieldConfig": {
            "defaults": {
              "custom": { "align": "auto" }
            },
            "overrides": [
              {
                "matcher": { "id": "byName", "options": "Ready" },
                "properties": [
                  {
                    "id": "mappings",
                    "value": [
                      { "options": { "1": { "text": "Ready", "color": "green" }, "0": { "text": "Not Ready", "color": "red" } }, "type": "value" }
                    ]
                  }
                ]
              }
            ]
          },
          "transformations": [
            {
              "id": "organize",
              "options": {
                "excludeByName": {
                  "Time": true,
                  "__name__": true,
                  "endpoint": true,
                  "instance": true,
                  "job": true,
                  "metrics_path": true,
                  "service": true,
                  "uid": true
                },
                "renameByName": {
                  "pod": "Pod",
                  "namespace": "Namespace",
                  "Value": "Ready",
                  "condition": "Condition"
                }
              }
            }
          ],
          "targets": [
            {
              "expr": "kube_pod_status_ready{namespace=\"openebs\", condition=\"true\"}",
              "legendFormat": "",
              "format": "table",
              "instant": true
            }
          ]
        },
        {
          "title": "OpenEBS Pod Restarts",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "gridPos": { "h": 6, "w": 24, "x": 0, "y": 46 },
          "fieldConfig": {
            "defaults": {
              "custom": {
                "lineWidth": 1,
                "fillOpacity": 10,
                "drawStyle": "line",
                "showPoints": "never"
              },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "red", "value": 1 }
                ]
              }
            },
            "overrides": []
          },
          "options": {
            "tooltip": { "mode": "multi" },
            "legend": { "displayMode": "list", "placement": "bottom" }
          },
          "targets": [
            {
              "expr": "increase(kube_pod_container_status_restarts_total{namespace=\"openebs\"}[1h])",
              "legendFormat": "{{ pod }}"
            }
          ]
        }
      ],
      "schemaVersion": 39,
      "tags": ["openebs", "storage", "pvc"],
      "templating": {
        "list": [
          {
            "name": "datasource",
            "type": "datasource",
            "query": "prometheus",
            "current": { "text": "Prometheus", "value": "Prometheus" }
          },
          {
            "name": "namespace",
            "type": "query",
            "datasource": { "type": "prometheus", "uid": "${datasource}" },
            "query": "label_values(kubelet_volume_stats_capacity_bytes, namespace)",
            "includeAll": true,
            "allValue": ".*",
            "current": { "text": "All", "value": "$__all" },
            "refresh": 2,
            "multi": true
          }
        ]
      },
      "time": { "from": "now-6h", "to": "now" },
      "title": "OpenEBS / PVC Overview",
      "uid": "openebs-pvc-overview"
    }
