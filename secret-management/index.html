<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="generator" content="mkdocs-1.6.1, mkdocs-terminal-4.8.0">
     
     
    <link rel="icon" type="image/png" sizes="192x192" href="../img/android-chrome-192x192.png" />
<link rel="icon" type="image/png" sizes="512x512" href="../img/android-chrome-512x512.png" />
<link rel="apple-touch-icon" sizes="180x180" href="../img/apple-touch-icon.png" />
<link rel="shortcut icon" type="image/png" sizes="48x48" href="../img/favicon.ico" />
<link rel="icon" type="image/png" sizes="16x16" href="../img/favicon-16x16.png" />
<link rel="icon" type="image/png" sizes="32x32" href="../img/favicon-32x32.png" />


    
 
<title>Secret Management - HomeLab GitOps</title>


<link href="../css/fontawesome/css/fontawesome.min.css" rel="stylesheet">
<link href="../css/fontawesome/css/solid.min.css" rel="stylesheet">
<link href="../css/normalize.css" rel="stylesheet">
<link href="../css/terminal.css" rel="stylesheet">
<link href="../css/theme.css" rel="stylesheet">
<link href="../css/theme.tile_grid.css" rel="stylesheet">
<link href="../css/theme.footer.css" rel="stylesheet">
<!-- default color palette -->
<link href="../css/palettes/default.css" rel="stylesheet">

<!-- page layout -->
<style>
/* initially set page layout to a one column grid */
.terminal-mkdocs-main-grid {
    display: grid;
    grid-column-gap: 1.4em;
    grid-template-columns: auto;
    grid-template-rows: auto;
}

/*  
*   when side navigation is not hidden, use a two column grid.  
*   if the screen is too narrow, fall back to the initial one column grid layout.
*   in this case the main content will be placed under the navigation panel. 
*/
@media only screen and (min-width: 70em) {
    .terminal-mkdocs-main-grid {
        grid-template-columns: 4fr 9fr;
    }
}</style>



     
    
    

    
    <!-- search css support -->
<link href="../css/search/bootstrap-modal.css" rel="stylesheet">
<!-- search scripts -->
<script>
    var base_url = "..",
    shortcuts = "{}";
</script>
<script src="../js/jquery/jquery-1.10.1.min.js" defer></script>
<script src="../js/bootstrap/bootstrap.min.js" defer></script>
<script src="../js/mkdocs/base.js" defer></script>
    
    
    
    
    <script src="../search/main.js"></script>
    

    
</head>

<body class="terminal"><div class="container">
    <div class="terminal-nav">
        <header class="terminal-logo">
            <div id="mkdocs-terminal-site-name" class="logo terminal-prompt"><a href="/" class="no-style">HomeLab GitOps</a></div>
        </header>
        
        <nav class="terminal-menu">
            
            <ul vocab="https://schema.org/" typeof="BreadcrumbList">
                
                
                <li property="itemListElement" typeof="ListItem">
                    <a href=".." class="menu-item " property="item" typeof="WebPage">
                        <span property="name">Welcome</span>
                    </a>
                    <meta property="position" content="0">
                </li>
                
                
                <li property="itemListElement" typeof="ListItem">
                    <a href="../backup/" class="menu-item " property="item" typeof="WebPage">
                        <span property="name">Backup</span>
                    </a>
                    <meta property="position" content="1">
                </li>
                
                
                <li property="itemListElement" typeof="ListItem">
                    <a href="../cloudflared/" class="menu-item " property="item" typeof="WebPage">
                        <span property="name">Cloudflared</span>
                    </a>
                    <meta property="position" content="2">
                </li>
                
                
                <li property="itemListElement" typeof="ListItem">
                    <a href="../ebs-lvm/" class="menu-item " property="item" typeof="WebPage">
                        <span property="name">Storage (OpenEBS LVM)</span>
                    </a>
                    <meta property="position" content="3">
                </li>
                
                
                <li property="itemListElement" typeof="ListItem">
                    <a href="../getting-started/" class="menu-item " property="item" typeof="WebPage">
                        <span property="name">Getting Started</span>
                    </a>
                    <meta property="position" content="4">
                </li>
                
                
                <li property="itemListElement" typeof="ListItem">
                    <a href="./" class="menu-item active" property="item" typeof="WebPage">
                        <span property="name">Secret Management</span>
                    </a>
                    <meta property="position" content="5">
                </li>
                
                    
                    


<li property="itemListElement" typeof="ListItem">
    <a href="#" class="menu-item" data-toggle="modal" data-target="#mkdocs_search_modal" property="item" typeof="SearchAction">
        <i aria-hidden="true" class="fa fa-search"></i> <span property="name">Search</span>
    </a>
    <meta property="position" content="6">
</li>
                    
            </ul>
            
        </nav>
    </div>
</div>
        
    <div class="container">
        <div class="terminal-mkdocs-main-grid"><aside id="terminal-mkdocs-side-panel"><nav>
    <ul class="terminal-mkdocs-side-nav-items">
        
          <li class="terminal-mkdocs-side-nav-li">
    
    
    
        
        
            <a class="terminal-mkdocs-side-nav-item" href="..">Welcome</a>
        
    
    
    
       </li>
        
          <li class="terminal-mkdocs-side-nav-li">
    
    
    
        
        
            <a class="terminal-mkdocs-side-nav-item" href="../backup/">Backup</a>
        
    
    
    
       </li>
        
          <li class="terminal-mkdocs-side-nav-li">
    
    
    
        
        
            <a class="terminal-mkdocs-side-nav-item" href="../cloudflared/">Cloudflared</a>
        
    
    
    
       </li>
        
          <li class="terminal-mkdocs-side-nav-li">
    
    
    
        
        
            <a class="terminal-mkdocs-side-nav-item" href="../ebs-lvm/">Storage (OpenEBS LVM)</a>
        
    
    
    
       </li>
        
          <li class="terminal-mkdocs-side-nav-li">
    
    
    
        
        
            <a class="terminal-mkdocs-side-nav-item" href="../getting-started/">Getting Started</a>
        
    
    
    
       </li>
        
          <li class="terminal-mkdocs-side-nav-li">
    
    
    
        
        <span class="terminal-mkdocs-side-nav-item--active">Secret Management</span>
    
    
    
       </li>
        
    </ul>
</nav><hr>
<nav>
    <ul>
        <li><a href="#secret-management">Secret Management</a></li>
        <li><a href="#vault">Vault</a></li><li><a href="#external-secrets">External Secrets</a></li><li><a href="#argocd-vault-plugin">ArgoCD Vault Plugin</a></li>
    </ul>
</nav>
</aside>
            <main id="terminal-mkdocs-main-content">
<section id="mkdocs-terminal-content">
    <h1 id="secret-management">Secret Management</h1>
<p>To avoid storing secrets in the repository, we use Vault to store them (e.g., API keys, passwords, etc.). We then use the External Secrets operator to sync the secrets stored in Vault with the Kubernetes cluster.</p>
<h2 id="vault">Vault</h2>
<p>Vault is a tool for securely accessing secrets. A secret is anything that you want to tightly control access to, such as API keys, passwords, or certificates. Vault provides a unified interface to any secret while providing tight access control and recording a detailed audit log.</p>
<p>It is installed in the <code>vault</code> namespace using the ArgoCD application defined in <code>cluster/bootstrap/vault.yaml</code>.</p>
<h3 id="initialize-the-vault-cluster">Initialize the Vault cluster</h3>
<p>Every time the Vault pod restarts, it must be unsealed. We use a single unseal key (acceptable for a homelab).</p>
<pre><code class="language-bash">kubectl exec -n vault vault-0 -- vault operator init \
    -key-shares=1 \
    -key-threshold=1 \
    -format=json &gt; cluster-keys.json
</code></pre>
<p>You obtain the root token in the <code>cluster-keys.json</code> file. Ensure to keep it safe and <strong>do not commit it to the repository</strong> (or encrypt it if you do).</p>
<pre><code class="language-bash">age -R ~/.ssh/id_ed25519.pub cluster-keys.json &gt; cluster-keys.json.age # Encrypt the file
age -d -i ~/.ssh/id_ed25519 cluster-keys.json.age &gt; cluster-keys.json # Decrypt the file
</code></pre>
<p>Now unseal Vault:</p>
<pre><code class="language-bash">export VAULT_UNSEAL_KEY=$(jq -r &quot;.unseal_keys_b64[]&quot; cluster-keys.json)
kubectl exec -n vault -ti vault-0 -- vault operator unseal $VAULT_UNSEAL_KEY
</code></pre>
<p>You can also use the Taskfile shortcut: <code>task vault-unseal</code>.</p>
<p>If the Vault pod restarts, you will need to unseal it again.</p>
<h3 id="enable-the-kv-secret-engine">Enable the KV secret engine</h3>
<p>Once Vault is ready, enable the KV v1 secret engine:</p>
<pre><code class="language-bash">kubectl port-forward -n vault svc/vault 8200:8200 &amp;
# Or use: task vault-port-forward

export VAULT_ADDR=&quot;http://localhost:8200&quot;
export VAULT_TOKEN=$(jq -r &quot;.root_token&quot; cluster-keys.json)
vault secrets enable -path=kv -version=1 kv
</code></pre>
<p>To test the Vault cluster, we can write a secret in the KV secret engine.</p>
<pre><code class="language-bash">vault kv put kv/foo my-value=s3cr3t
</code></pre>
<h2 id="external-secrets">External Secrets</h2>
<p>External Secrets allows you to use secrets stored in external secret management systems like HashiCorp Vault. It is installed in the <code>external-secrets</code> namespace using the ArgoCD application in <code>cluster/system/external-secret/</code>.</p>
<p><em>Note: This is actually the root token, which is not recommended for production use. In a production environment, you should create a dedicated token with the appropriate policies.</em></p>
<p><strong><em>Create a secret with the Vault token</em></strong></p>
<p>This is already handled by the bootstrap process, but if needed manually:</p>
<pre><code class="language-bash">kubectl create secret generic vault-token \
  --namespace external-secrets \
  --from-literal=token=$(jq -r &quot;.root_token&quot; cluster-keys.json)
</code></pre>
<p><strong><em>ClusterSecretStore</em></strong></p>
<p>The ClusterSecretStore is defined in <code>cluster/system/external-secret/cluster-store.yaml</code> and points to Vault.</p>
<h3 id="test-the-external-secrets">Test the External Secrets</h3>
<p><strong><em>Create an External Secret that syncs the secret in Vault with the Kubernetes cluster</em></strong></p>
<pre><code class="language-bash">cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: vault-example
  namespace: default
spec:
  refreshInterval: &quot;15s&quot;
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: example-sync # Name of the Secret in the target namespace
  data:
  - secretKey: foobar
    remoteRef:
      key: foo
      property: my-value
EOF
</code></pre>
<h2 id="argocd-vault-plugin">ArgoCD Vault Plugin</h2>
<p>For many applications, the ArgoCD Vault Plugin is used to inline Vault secrets into any Kubernetes manifest â€” not just Secrets but also ConfigMaps, Deployments, Ingresses, etc.</p>
<p><strong><em>Create a secret with the Vault token for the Vault Plugin</em></strong></p>
<pre><code class="language-bash">kubectl create secret generic vault-credentials \
  --namespace argocd \
  --from-literal=AVP_AUTH_TYPE=token \
  --from-literal=AVP_KV_VERSION=1 \
  --from-literal=AVP_TYPE=vault \
  --from-literal=VAULT_ADDR=http://vault.vault.svc.cluster.local:8200 \
  --from-literal=VAULT_TOKEN=$(jq -r &quot;.root_token&quot; cluster-keys.json)
</code></pre>
<p>After creating this secret, the ArgoCD <code>repo-server</code> AVP sidecar containers (deployed automatically via the bootstrap kustomization) will be able to connect to Vault and resolve <code>&lt;path:kv/...&gt;</code> placeholders.</p>
<p>The AVP configuration is defined in <code>cluster/argocd/vault-argocd/</code>, which patches the <code>argocd-repo-server</code> Deployment with AVP sidecar containers and the CMP plugin ConfigMap.</p>
<p>Once everything is applied, you can use AVP placeholders in any manifest. For example, to hide the domain in an Ingress:</p>
<pre><code class="language-yaml">apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: my-app
  annotations:
    cert-manager.io/cluster-issuer: cloudflare
spec:
  ingressClassName: traefik
  rules:
  - host: &quot;my-app.&lt;path:kv/cluster#domain&gt;&quot;
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: my-app
            port:
              number: 80
  tls:
  - hosts:
    - &quot;my-app.&lt;path:kv/cluster#domain&gt;&quot;
    secretName: my-app-tls
</code></pre>
<p>The <code>&lt;path:kv/cluster#domain&gt;</code> placeholder is replaced at sync time by the ArgoCD Vault Plugin with the value from Vault.</p>
</section>

            </main>
        </div>
        <hr><footer>
    <div class="terminal-mkdocs-footer-grid">
        <div id="terminal-mkdocs-footer-copyright-info">
             Site built with <a href="http://www.mkdocs.org">MkDocs</a> and <a href="https://github.com/ntno/mkdocs-terminal">Terminal for MkDocs</a>.
        </div>
    </div>
</footer>
    </div>

    
    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="alertdialog" aria-modal="true" aria-labelledby="searchModalLabel">
    <div class="modal-dialog modal-lg" role="search">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchModalLabel">Search</h5>
                <button type="button" class="close btn btn-default btn-ghost" data-dismiss="modal" aria-label="Close">x</button>
            </div>
            <div class="modal-body">
                <p id="searchInputLabel">Type to start searching</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" aria-labelledby="searchInputLabel" placeholder="" id="mkdocs-search-query" title="Please enter search terms here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No document matches found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    
    
</body>

</html>